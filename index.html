<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"><title>BITTER & WHITE</title><link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet"><style>:root{--main-pink:#ff80ab;--black-choco:#3e2723;--white-choco:#fff9c4}body,html{margin:0;padding:0;height:100%;font-family:'Yomogi',cursive;background-color:#fce4ec;overflow:hidden;touch-action:none}.screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;text-align:center;position:relative}.piece-title{width:16px;height:32px;border-radius:2px;position:fixed;transition:transform 3.5s cubic-bezier(0.22,1,0.36,1),opacity 3s;z-index:1000}.black-piece-title{background:var(--black-choco);border:1.5px solid #5d4037}.white-piece-title{background:var(--white-choco);border:1.5px solid #fff}#game-wrapper{display:none;width:100vw;height:100vh;background:#000;position:fixed;top:0;left:0;z-index:2000;flex-direction:column;align-items:center;justify-content:center}#game-container{position:relative;height:95vh;width:calc(95vh*1153/1878);max-width:100vw;background-color:#1a1a1a;overflow:hidden;box-shadow:0 0 40px #000;transition:height 0.5s}#bg-image-layer{position:absolute;top:0;left:0;width:100%;height:calc(100%*1728/1878);background-size:100% 100%;z-index:2010}#yajuu-curtain{position:absolute;top:0;left:0;width:100%;height:100%;background-size:100% 100%;z-index:2015;display:none;transition:clip-path 1.0s linear}.bitter-heart,.white-heart{position:absolute;z-index:2020;display:flex;align-items:center;justify-content:center;pointer-events:none;animation:heartBeat 1.2s infinite;cursor:pointer}.bitter-heart::before,.bitter-heart::after{content:"";position:absolute;top:0;width:50%;height:80%;background:var(--black-choco);border:2.5px solid #5d4037}.bitter-heart::before{left:50%;transform:rotate(-45deg);transform-origin:0 100%}.bitter-heart::after{left:0;transform:rotate(45deg);transform-origin:100% 100%}.white-heart::before,.white-heart::after{content:"";position:absolute;top:0;width:50%;height:80%;background:var(--white-choco);border:2.5px solid #fff}.white-heart::before{left:50%;transform:rotate(-45deg);transform-origin:0 100%}.white-heart::after{left:0;transform:rotate(45deg);transform-origin:100% 100%}.normal-heart::before,.normal-heart::after{border-radius:50px 50px 0 0}.large-heart::before,.large-heart::after{border-radius:400px 400px 0 0}.heart-active{pointer-events:auto!important}#game-canvas{width:100%;height:100%;display:block;position:absolute;top:0;left:0;z-index:2100;pointer-events:auto;background:transparent}.howawa{position:absolute;color:var(--main-pink);pointer-events:none;z-index:3000;animation:a 1.5s ease-out forwards;font-size:2rem}@keyframes a{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-100px) scale(1.5);opacity:0}}.canvas-pass{pointer-events:none!important}#volume-controls{position:fixed;top:20px;right:20px;z-index:3000;display:flex;flex-direction:column;gap:10px;background:rgba(255,255,255,0.8);padding:10px;border-radius:10px}#hud-left{position:absolute;top:20px;left:20px;z-index:3000;display:none;align-items:center;gap:10px}.hud-ball{width:24px;height:24px;border-radius:50%;border:2px solid rgba(255,255,255,0.5);box-shadow:2px 2px 5px rgba(0,0,0,0.3)}.vol-bar-wrapper{display:flex;align-items:flex-end;gap:4px;height:30px;cursor:pointer}.vol-bar{width:8px;background:#ddd;transition:background .2s}.vol-bar.active{background:var(--main-pink)}.vol-bar:nth-child(1){height:20%}.vol-bar:nth-child(2){height:40%}.vol-bar:nth-child(3){height:60%}.vol-bar:nth-child(4){height:80%}.vol-bar:nth-child(5){height:100%}.game-btn{display:none;position:absolute;bottom:15px;left:50%;transform:translateX(-50%);padding:8px 25px;font-family:'Yomogi',cursive;font-size:1.2rem;background:var(--main-pink);color:#fff;border:2px solid #fff;border-radius:50px;cursor:pointer;z-index:2800}.input-container{background:#fff;padding:30px;border-radius:20px;width:min(400px,90vw);z-index:50}.age-row,.input-row{margin-bottom:20px;font-size:1.8rem;color:var(--main-pink);display:flex;align-items:center;justify-content:center;gap:10px}input[type="text"]{font-family:'Yomogi',cursive;border:3px solid var(--main-pink);border-radius:12px;padding:5px;text-align:center;color:var(--main-pink);font-size:1.8rem}.heart-wrapper{position:relative;width:70px;height:65px;animation:heartBeat 1s infinite;transform:scale(0.8)}.heart-wrapper::before,.heart-wrapper::after{content:"";position:absolute;top:0;width:35px;height:55px;background:var(--main-pink);border-radius:35px 35px 0 0}.heart-wrapper::before{left:35px;transform:rotate(-45deg);transform-origin:0 100%}.heart-wrapper::after{left:0;transform:rotate(45deg);transform-origin:100% 100%}#passInput{position:relative;width:50px;height:50px;z-index:10;border:none;background:0 0;color:#fff;font-size:2rem;text-align:center;outline:none}.btn{padding:12px 40px;font-size:1.5rem;font-family:'Yomogi',cursive;background:var(--main-pink);color:#fff;border:none;border-radius:50px;cursor:pointer}@keyframes heartBeat{0%,100%{transform:scale(0.8)}20%{transform:scale(1.0)}}#dog-layer{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:2050;pointer-events:none}.emoji-char{position:absolute;font-size:3rem;line-height:1;transform:translate(-50%,-50%);transition:none}#btn-dog-exit{display:none;margin-top:20px;position:relative;bottom:auto;left:auto;transform:none;font-size:1.5rem;padding:10px 40px;background:var(--main-pink);border:3px solid #fff}</style></head><body><audio id="bgm-title" src="bgm_title.mp3" loop></audio><audio id="bgm-stage1" src="bgm_bitter_st1.mp3" loop></audio><audio id="bgm-ex" src="bgm_bitter_ex.mp3" loop></audio><audio id="bgm-white-st1" src="bgm_white_st1.mp3" loop></audio><audio id="bgm-white-ex" src="bgm_white_ex.mp3" loop></audio><audio id="bgm-clear" src="bgm_clear.mp3" loop></audio><audio id="bgm-yajuu-a" src="bgm_yajuu_a.mp3" loop></audio><audio id="bgm-yajuu-b" src="bgm_yajuu_b.mp3" loop></audio><audio id="bgm-dog" src="bgm_dog_run.mp3" loop></audio><div id="volume-controls"><div style="display:flex;gap:10px"><span onclick="setVolume('bgm',0,true,true)" style="cursor:pointer">BGM</span><div class="vol-bar-wrapper" id="bgm-ctrl"><div class="vol-bar active" onclick="setVolume('bgm',1,true,true)"></div><div class="vol-bar active" onclick="setVolume('bgm',2,true,true)"></div><div class="vol-bar active" onclick="setVolume('bgm',3,true,true)"></div><div class="vol-bar" onclick="setVolume('bgm',4,true,true)"></div><div class="vol-bar" onclick="setVolume('bgm',5,true,true)"></div></div></div><div style="display:flex;gap:10px"><span onclick="setVolume('se',0,true,true)" style="cursor:pointer">SE</span><div class="vol-bar-wrapper" id="se-ctrl"><div class="vol-bar active" onclick="setVolume('se',1,true,true)"></div><div class="vol-bar active" onclick="setVolume('se',2,true,true)"></div><div class="vol-bar active" onclick="setVolume('se',3,true,true)"></div><div class="vol-bar" onclick="setVolume('se',4,true,true)"></div><div class="vol-bar" onclick="setVolume('se',5,true,true)"></div></div></div></div><div id="hud-left"><div id="hud-ball" class="hud-ball"></div><span style="font-size:1.5rem;color:#fff;text-shadow:2px 2px 0 #3e2723">√ó</span><span id="lives-val" style="font-size:2rem;color:#ff80ab;font-weight:bold;text-shadow:2px 2px 0 #3e2723">0</span></div><div id="title-screen" class="screen"><h1 style="font-size:min(3.5rem,10vw);z-index:10"><span style="color:#3e2723">BITTER</span> <span style="color:#ff80ab">&</span> <span style="color:#fff9c4">WHITE</span></h1><button class="btn" onclick="triggerStart()">„ÅØ„Åò„ÇÅ„Çã</button></div><div id="pass-screen" class="screen" style="display:none"><div class="input-container"><div class="age-row">„Å≠„Çì„Çå„ÅÑ <input type="text" id="ageInput" maxlength="6" style="width:100px"> „Åï„ÅÑ</div><div class="input-row">„ÉÅ <div class="heart-wrapper"><input type="text" id="passInput" maxlength="1"></div> „Ç≥„Åè„Å†„Åï„ÅÑüíó</div><button class="btn" onclick="checkAll()">Â±ä„Åë„ÄÅ„Åì„ÅÆ„Ç≠„É¢„ÉÅ„Éª„Éª„ÉªÔºÅ</button><p id="msg" style="color:#d81b60;margin-top:15px;font-weight:bold;min-height:1.2em"></p></div></div><div id="game-wrapper"><div id="game-container"><div id="bg-image-layer"></div><div id="yajuu-curtain"></div><div id="dog-layer"><div id="emoji-dog" class="emoji-char">üê∂</div><div id="emoji-hand" class="emoji-char">‚úã</div></div><button id="btn-restart" class="game-btn" onclick="location.reload()">„ÅØ„Åò„ÇÅ„Åã„Çâ</button><button id="btn-finish" class="game-btn" onclick="location.reload()">„Åä„Çè„Çä</button><div id="heart-1" class="bitter-heart normal-heart" onclick="hc(event,'heart-1')"></div><div id="heart-2" class="bitter-heart normal-heart" onclick="hc(event,'heart-2')"></div><div id="heart-large" class="bitter-heart large-heart" onclick="hc(event,'heart-large')"></div><canvas id="game-canvas"></canvas></div><button id="btn-dog-exit" class="game-btn" onclick="location.reload()">„Åæ„Åü„Å≠</button></div><script>
const ac=new(window.AudioContext||window.webkitAudioContext),NW=1153,NH=1728,NM=150,YW=1664,YH=1216,YM=100;let bVol=0.6,sVol=0.6,cBgm=null,IW=NW,IH=NH,MH=NM,VW=IW,VH=IH+MH,ball,pad,run=false,lives=0,stg=1,blks=[],clkH=new Set(),hBlks=[],stgClr=false,pHid=false,exT=0,clrT=0,mode='black',yTrig=false,yAnim=false,gOv=false,goT=0;
let dog={x:0,y:0,state:'idle',tx:0,ty:0},hand={x:0,y:0};
const fps=60,fpsInterval=1000/fps;let then=Date.now(),elapsed;
const cv=document.getElementById('game-canvas'),ctx=cv.getContext('2d');
function loadVol(){const b=localStorage.getItem('bw_bgm_vol'),s=localStorage.getItem('bw_se_vol');if(b)setVolume('bgm',parseInt(b),false,false);if(s)setVolume('se',parseInt(s),false,false)}
function setVolume(t,l,p=true,toggle=false){
  const k='bw_'+t+'_vol';const c=parseInt(localStorage.getItem(k)||3);if(toggle&&l===1&&c===1)l=0;
  let v=l/5.0;if(t==='bgm'){bVol=v;if(cBgm)cBgm.volume=v;localStorage.setItem(k,l)}else{sVol=v;if(l>0&&p)pt(880,0.1);localStorage.setItem(k,l)}document.querySelectorAll(`#${t}-ctrl .vol-bar`).forEach((b,i)=>b.classList.toggle('active',i<l))}
function swBgm(id){if(cBgm){cBgm.pause();cBgm.currentTime=0}if(!id)return;const n=document.getElementById(id);if(n){n.volume=bVol;n.play().catch(()=>{});cBgm=n}}
document.addEventListener('click',()=>{if(ac.state==='suspended')ac.resume();if(cBgm&&cBgm.paused)cBgm.play()},{once:true});
document.addEventListener('touchstart',()=>{if(ac.state==='suspended')ac.resume();if(cBgm&&cBgm.paused)cBgm.play()},{once:true});
function pt(f,d=0.2){if(sVol<=0.01)return;if(ac.state==='suspended')ac.resume();const o=ac.createOscillator(),g=ac.createGain();o.frequency.setValueAtTime(f,ac.currentTime);g.gain.setValueAtTime(0.3*sVol,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.0001,ac.currentTime+d);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+d)}
window.onload=()=>{loadVol();createChoco();swBgm('bgm-title')};
function createChoco(){const cx=innerWidth/2,cy=innerHeight/2,off=innerWidth>600?250:150;for(let r=0;r<4;r++)for(let c=0;c<3;c++){let w=document.createElement('div'),b=document.createElement('div');w.className='piece-title white-piece-title';b.className='piece-title black-piece-title';w.style.left=(cx-off-50+c*17)+'px';w.style.top=(cy-65+r*33)+'px';b.style.left=(cx+off+c*17)+'px';b.style.top=(cy-65+r*33)+'px';document.body.append(w,b)}}
function triggerStart(){pt(523.3);document.querySelectorAll('.piece-title').forEach(p=>{const rx=(Math.random()-0.5)*800,jy=-250-Math.random()*200;p.style.transform=`translate(${rx*0.2}px,${jy}px) rotate(${(Math.random()-0.5)*150}deg)`;setTimeout(()=>{p.style.transform=`translate(${rx}px,${innerHeight+1000}px)`;p.style.opacity='0'},250)});setTimeout(()=>{document.getElementById('title-screen').style.display='none';document.getElementById('pass-screen').style.display='flex'},1000)}
function checkAll(){const ar=document.getElementById('ageInput').value.trim(),pw=document.getElementById('passInput').value.trim(),age=parseInt(ar.replace(/[Ôºê-Ôºô]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)));if(isNaN(age)){document.getElementById('msg').innerText="„Å≠„Çì„Çå„ÅÑ„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠";return}lives=age;
if(age<=17)init('dog');else if(age>=121&&age!=114514)document.getElementById('msg').innerText="Âπ¥Èáë„Åß„ÉÅ„Éß„Ç≥Ë≤∑„Åà„ÇàËÄÅ„ÅÑ„Åº„Çå";else if(age==114514)init('yajuu');else if((pw=='„É≥'||pw=='Ôæù')&&age>=18&&age<=120)init('white');else if(pw=='„Éß'||pw=='ÔΩÆ')init('black');else document.getElementById('msg').innerText="„Åù„Çì„Å™„Ç≠„É¢„ÉÅ„Åò„ÇÉÂ±ä„Åã„Å™„ÅÑ„Çà„Éª„Éª„ÉªÔºü"}
function setHS(id,x,y,w,h){const e=document.getElementById(id);e.style.left=(x/VW*100)+'%';e.style.top=(y/VH*100)+'%';e.style.width=(w/VW*100)+'%';e.style.height=(h/VH*100)+'%';e.style.display='flex'}
function drawStaticBlocks(m){
    // Immediate render to prevent subliminal flash
    ctx.clearRect(0,0,VW,VH);
    if(m==='dog') return;
    ctx.fillStyle=mode==='white'?'#ffffff':'#111';ctx.fillRect(0,IH,VW,MH);
    let blc=mode==='white'?'#fff9c4':mode==='yajuu'?'#f06292':'#3e2723',bld=mode==='white'?'#fff':mode==='yajuu'?'#ad1457':'#5d4037';
    blks.forEach(b=>{if(b.alive){ctx.fillStyle=blc;ctx.fillRect(b.x,b.y,b.w,b.h);ctx.strokeStyle=bld;ctx.lineWidth=2;ctx.strokeRect(b.x,b.y,b.w,b.h)}});
}
function init(m){mode=m;const c=document.getElementById('game-container'),bg=document.getElementById('bg-image-layer'),cu=document.getElementById('yajuu-curtain'),h1=document.getElementById('heart-1'),h2=document.getElementById('heart-2'),hL=document.getElementById('heart-large'),dl=document.getElementById('dog-layer');
[h1,h2,hL].forEach(h=>{h.className='bitter-heart normal-heart';h.style='';if(h.id.includes('large'))h.className='bitter-heart large-heart';h.style.display='none'});dl.style.display='none';
if(m==='yajuu'){IW=YW;IH=YH;MH=YM;c.style.cssText=`height:auto;width:95vw;aspect-ratio:${YW}/${YH+YM};max-width:100vw;max-height:95vh;background:#1a1a1a`;bg.style.height='100%';swBgm('bgm-yajuu-a');bg.style.backgroundImage="url('yajuu_bg_b.png')";cu.style.display='block';cu.style.backgroundImage="url('yajuu_bg_a.png')";cu.style.clipPath='inset(0 0 0% 0)'}
else if(m==='dog'){IW=NW;IH=NH;MH=0;c.style.cssText=`height:85vh;width:calc(85vh*${NW}/${NH});background:#8bc34a;border:10px solid #558b2f;box-sizing:border-box`;bg.style.display='none';swBgm('bgm-dog');dl.style.display='block';document.getElementById('btn-dog-exit').style.display='block';dog.x=IW/2;dog.y=IH/2;dog.state='idle'}
else{IW=NW;IH=NH;MH=NM;c.style='';bg.style.height=`calc(100% * ${NH}/${NH+NM})`;bg.style.display='block';cu.style.display='none';
[h1,h2,hL].forEach(h=>h.style.display='flex');
if(m==='white'){c.style.backgroundColor='#fff';swBgm('bgm-white-st1');bg.style.backgroundImage="url('white_bg.png')";[h1,h2,hL].forEach(h=>h.classList.add('white-heart'));setHS('heart-1',300,500,150,150);setHS('heart-2',600,1100,200,200);setHS('heart-large',275,1175,650,650);hBlks=[{id:'heart-1',x:300,y:500,w:150,h:150,alive:true},{id:'heart-2',x:600,y:1100,w:200,h:200,alive:true},{id:'heart-large',x:275,y:1175,w:650,h:650,alive:true}]}
else{c.style.backgroundColor='#1a1a1a';swBgm('bgm-stage1');bg.style.backgroundImage="url('bitter_bg.png')";[h1,h2,hL].forEach(h=>h.classList.add('bitter-heart'));setHS('heart-1',300,400,150,150);setHS('heart-2',850,400,150,150);setHS('heart-large',200,1050,750,750);hBlks=[{id:'heart-1',x:300,y:400,w:150,h:150,alive:true},{id:'heart-2',x:850,y:400,w:150,h:150,alive:true},{id:'heart-large',x:200,y:1050,w:750,h:750,alive:true}]}}
VW=IW;VH=IH+MH;cv.width=VW;cv.height=VH;document.getElementById('pass-screen').style.display='none';document.getElementById('game-wrapper').style.display='flex';document.getElementById('hud-left').style.display=m==='dog'?'none':'flex';document.getElementById('btn-restart').style.display='none';document.getElementById('btn-finish').style.display='none';
pad={x:VW/2-125,y:VH-60,w:250,h:40};ball={x:VW/2,y:pad.y-30,dx:0,dy:0,r:20,active:false};mkBlks(m);drawStaticBlocks(m);then=Date.now();run=true;yTrig=false;yAnim=false;gOv=false;goT=0;requestAnimationFrame(loop)}
function mkBlks(m){blks=[];if(m==='dog')return;const cs=10,bw=VW/cs,bh=40,rn=Math.ceil(IH/bh),tids=[174,184,194,204,214,224,234];let bi=0;for(let r=0;r<rn;r++)for(let c=0;c<cs;c++){blks.push({id:bi,x:c*bw,y:r*bh,w:bw,h:bh,alive:true,isTrigger:m==='yajuu'&&tids.includes(bi)});bi++}}
function yTrans(){yTrig=true;yAnim=true;run=false;swBgm(null);const th=IH,rh=40,tr=Math.ceil(th/rh),cu=document.getElementById('yajuu-curtain');let cr=0;const t=setInterval(()=>{cr++;cu.style.clipPath=`inset(0 0 ${cr*rh/th*100}% 0)`;if(cr>=tr){clearInterval(t);cu.style.display='none';yAnim=false;run=true;swBgm('bgm-yajuu-b')}},1000)}
function hc(e,id){if(stgClr&&stg===1){for(let i=0;i<3;i++){const h=document.createElement('div');h.className='howawa';h.innerText='üíó';h.style.left=e.clientX+(Math.random()-0.5)*50+'px';h.style.top=e.clientY+(Math.random()-0.5)*50+'px';document.body.appendChild(h);setTimeout(()=>h.remove(),1500)}if(!clkH.has(id)){pt(880,0.1);clkH.add(id)}if(clkH.size===3){stg=2;stgClr=false;pHid=false;exT=180;pt(1046.5,0.5);swBgm(mode==='white'?'bgm-white-ex':'bgm-ex');cv.classList.remove('canvas-pass');document.getElementById('btn-restart').style.display='none';document.querySelectorAll('.bitter-heart,.white-heart').forEach(h=>h.classList.remove('heart-active'));ball.active=false;ball.x=pad.x+pad.w/2;ball.y=pad.y-ball.r-5}}}
function loop(){
requestAnimationFrame(loop);
const now=Date.now();elapsed=now-then;
if(elapsed<=fpsInterval)return;
then=now-(elapsed%fpsInterval);
ctx.clearRect(0,0,VW,VH);
if(mode==='dog'){
const eh=document.getElementById('emoji-hand'),ed=document.getElementById('emoji-dog');eh.style.left=(hand.x/VW*100)+'%';eh.style.top=(hand.y/VH*100)+'%';ed.style.left=(dog.x/VW*100)+'%';ed.style.top=(dog.y/VH*100)+'%';
if(dog.state==='holding'){ball.x=dog.x;ball.y=dog.y+20}
else if(!ball.active){ball.x=hand.x;ball.y=hand.y}
else{ball.x+=ball.dx;ball.y+=ball.dy;if(ball.x<ball.r||ball.x>VW-ball.r){ball.dx*=-0.8;ball.x=Math.max(ball.r,Math.min(VW-ball.r,ball.x))}if(ball.y<ball.r||ball.y>VH-ball.r){ball.dy*=-0.8;ball.y=Math.max(ball.r,Math.min(VH-ball.r,ball.y));ball.dx*=0.98;ball.dy*=0.98}}
if(dog.state==='chasing'){const dx=ball.x-dog.x,dy=ball.y-dog.y,dist=Math.sqrt(dx*dx+dy*dy);if(dist<30){dog.state='holding';ball.active=false}else{dog.x+=dx/dist*12;dog.y+=dy/dist*12}}
else if(dog.state==='holding'){const dx=hand.x-dog.x,dy=hand.y-dog.y,dist=Math.sqrt(dx*dx+dy*dy);if(dist<50){dog.state='idle';pt(600,0.1)}else{dog.x+=dx/dist*10;dog.y+=dy/dist*10}}
else if(ball.active&&Math.abs(ball.dx)+Math.abs(ball.dy)>0.5){dog.state='chasing'}
ctx.fillStyle='red';ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);ctx.fill();
}
else{
ctx.fillStyle=mode==='white'?'#ffffff':'#111';ctx.fillRect(0,IH,VW,MH);document.getElementById('lives-val').innerText=lives;
let pc='#ff80ab',bc='#fff9c4';if(mode==='white')bc='#3e2723';else if(mode==='yajuu'){if(!yTrig||yAnim){pc=bc='#fff'}else{pc=bc='#964B00'}}
document.getElementById('hud-ball').style.backgroundColor=bc;
if(stg===2&&exT>0){ctx.fillStyle=`rgba(255,255,255,${Math.min(1,exT/60)})`;ctx.font="bold 120px 'Yomogi'";ctx.textAlign="center";ctx.fillText("EX STAGE",VW/2,VH/2);ctx.textAlign="start";exT--}
if(stgClr&&clrT>0){ctx.fillStyle=`rgba(255,255,255,${Math.min(1,clrT/60)})`;ctx.font="bold 120px 'Yomogi'";ctx.textAlign="center";ctx.fillText("STAGE CLEAR",VW/2,VH/2);ctx.textAlign="start";clrT--}
if(stg===1&&!stgClr){let blc=mode==='white'?'#fff9c4':mode==='yajuu'?'#f06292':'#3e2723',bld=mode==='white'?'#fff':mode==='yajuu'?'#ad1457':'#5d4037';blks.forEach(b=>{if(b.alive){ctx.fillStyle=blc;ctx.fillRect(b.x,b.y,b.w,b.h);ctx.strokeStyle=bld;ctx.lineWidth=2;ctx.strokeRect(b.x,b.y,b.w,b.h)}})}
if(gOv){ctx.fillStyle="#ff80ab";ctx.font="bold 100px 'Yomogi'";ctx.textAlign="center";ctx.fillText("GAME OVER",VW/2,VH/2);ctx.textAlign="start";goT--;if(goT<=0)location.reload();}
else if(run||(!run&&!yAnim)){if(!pHid){ctx.fillStyle=pc;ctx.beginPath();ctx.roundRect(pad.x,pad.y,pad.w,pad.h,15);ctx.fill()}if(ball.active||(!stgClr&&!ball.active&&!pHid)){ctx.fillStyle=bc;ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);ctx.fill()}}
if(run&&!gOv){if(ball.active){const st=4;let sx=ball.dx/st,sy=ball.dy/st;for(let i=0;i<st;i++){ball.x+=sx;ball.y+=sy;if(ball.x<ball.r){ball.x=ball.r;ball.dx=Math.abs(ball.dx);sx=ball.dx/st}if(ball.x>VW-ball.r){ball.x=VW-ball.r;ball.dx=-Math.abs(ball.dx);sx=ball.dx/st}if(ball.y<ball.r){ball.y=ball.r;ball.dy=Math.abs(ball.dy);sy=ball.dy/st}
if(!pHid&&ball.dy>0&&ball.y+ball.r>=pad.y&&ball.y-ball.r<=pad.y+pad.h&&ball.x+ball.r>=pad.x&&ball.x-ball.r<=pad.x+pad.w){ball.dy=-Math.abs(ball.dy);ball.y=pad.y-ball.r-2;sy=ball.dy/st;pt(660,0.1)}
if(stg===1&&!stgClr){blks.forEach(b=>{if(b.alive){if(ball.x+ball.r>b.x&&ball.x-ball.r<b.x+b.w&&ball.y+ball.r>b.y&&ball.y-ball.r<b.y+b.h){b.alive=false;pt(400,0.05);if(mode==='yajuu'&&b.isTrigger&&!yTrig)yTrans()}}})}
if(stg===2&&!stgClr){hBlks.forEach(h=>{if(h.alive){if(ball.x+ball.r>h.x&&ball.x-ball.r<h.x+h.w&&ball.y+ball.r>h.y&&ball.y-ball.r<h.y+h.h){h.alive=false;ball.dy*=-1;sy=ball.dy/st;pt(220,0.3);document.getElementById(h.id).style.display='none'}}})}}
if(ball.y>VH){lives--;if(lives<=0){gOv=true;goT=300;ball.active=false}else ball.active=false}}else if(!stgClr&&!pHid){ball.x=pad.x+pad.w/2;ball.y=pad.y-ball.r-5}
if(stg===1&&!stgClr){if(blks.filter(b=>b.alive).length===0&&blks.length>0){ball.active=false;stgClr=true;clrT=240;pHid=true;const b=document.getElementById('btn-restart');b.style.display='block';if(mode==='yajuu'){swBgm('bgm-clear');b.innerText="ÁµÇ„Çè„ÇäÔºÅÈñâÂª∑ÔºÅ„Éª„Éª„Éª‰ª•‰∏äÔºÅÁöÜËß£Êï£ÔºÅ";b.style.fontSize="1.0rem";b.style.width="90%"}else{b.innerText="„ÅØ„Åò„ÇÅ„Åã„Çâ";b.style.fontSize="1.2rem";b.style.width="auto";pt(440,0.2);document.querySelectorAll('.bitter-heart,.white-heart').forEach(h=>h.classList.add('heart-active'));cv.classList.add('canvas-pass')}}}
if(stg===2&&!stgClr){if(hBlks.filter(b=>b.alive).length===0){ball.active=false;stgClr=true;clrT=240;pHid=true;document.getElementById('btn-finish').style.display='block';swBgm('bgm-clear')}}}}}
function hm(e){
const r=cv.getBoundingClientRect(),x=e.touches?e.touches[0].clientX:e.clientX,y=e.touches?e.touches[0].clientY:e.clientY,s=VW/r.width,sh=VH/r.height;
if(mode==='dog'){hand.x=(x-r.left)*s;hand.y=(y-r.top)*sh;if(hand.x<0)hand.x=0;if(hand.x>VW)hand.x=VW;if(hand.y<0)hand.y=0;if(hand.y>VH)hand.y=VH}
else{if(yAnim)return;pad.x=(x-r.left)*s-pad.w/2;if(pad.x<0)pad.x=0;if(pad.x>VW-pad.w)pad.x=VW-pad.w}}
window.addEventListener('mousemove',hm);window.addEventListener('touchmove',e=>{hm(e);e.preventDefault()},{passive:false});
window.addEventListener('mousedown',()=>{
if(mode==='dog'){if(!ball.active&&dog.state==='idle'){ball.active=true;const dx=hand.x-VW/2,dy=hand.y-VH/2,mag=Math.sqrt(dx*dx+dy*dy)||1;ball.dx=(dx/mag)*20;ball.dy=(dy/mag)*20;pt(500,0.1)}}
else if(!ball.active&&!stgClr&&!pHid&&!yAnim&&!gOv){ball.active=true;ball.dx=14;ball.dy=-14}});
window.addEventListener('touchstart',e=>{
if(mode==='dog'){if(!ball.active&&dog.state==='idle'){ball.active=true;const dx=hand.x-VW/2,dy=hand.y-VH/2,mag=Math.sqrt(dx*dx+dy*dy)||1;ball.dx=(dx/mag)*20;ball.dy=(dy/mag)*20;pt(500,0.1)}}
else if(!ball.active&&!stgClr&&!pHid&&!yAnim&&!gOv){ball.active=true;ball.dx=14;ball.dy=-14}e.preventDefault()},{passive:false});
</script></body></html>